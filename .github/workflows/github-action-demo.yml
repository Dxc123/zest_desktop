name: Flutter è‡ªåŠ¨åŒ–æ‰“åŒ…
#è§¦å‘äº‹ä»¶
on:
  push:
    branches:
      - master  # æŒ‡å®šè§¦å‘æ„å»ºçš„åˆ†æ”¯
#    tags:   #æŒ‡å®šè§¦å‘æ„å»ºçš„æŸä¸ª tagç‰ˆæœ¬ å¦‚ï¼šgit tag v1.0.0 , git push --tags
#      - "v*"

# å¹¶å‘ç­–ç•¥
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  # å¦‚æœæœ‰æ–°çš„è¿è¡Œå®ä¾‹ï¼Œå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„å®ä¾‹
  cancel-in-progress: true


jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ‹‰å–å¹¶æ£€æµ‹ä»£ç 
        uses: actions/checkout@v4

#      - name: è®¾ç½® JDK ç¯å¢ƒ
#        uses: actions/setup-java@v4
#        with:
#          distribution: 'zulu'
#          java-version: '17' # æ ¹æ®é¡¹ç›®ä½¿ç”¨çš„ Java ç‰ˆæœ¬è°ƒæ•´
#
#      - name:  ç¼“å­˜ Gradle ç¼“å­˜ç›®å½•
#        uses: actions/cache@v3
#        with:
#          path: |
#            ~/.gradle/caches
#            ~/.gradle/wrapper
#          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
#          restore-keys: |
#            ${{ runner.os }}-gradle-
#
#      - name: å®‰è£… Android SDK
#        uses: android-actions/setup-android@v3
#        with:
#          api-level: 33
#          build-tools: '33.0.2'
#          target: 'android-33'

      # è®¾ç½® Flutter ç¯å¢ƒ
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
           channel: stable
           flutter-version: 3.27.1

      - name: è§£ç  Keystore æ–‡ä»¶
        run: echo "${{ secrets.KEY_STORE_BASE64 }}" | base64 -d > keystore.jks

      # é…ç½®ç­¾åæ–‡ä»¶
      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.KEY_STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=testhani.jks" >> android/key.properties

      - name: ä¿å­˜ç”Ÿæˆçš„ APK
        uses: actions/upload-artifact@v3
        with:
          name: app-release-apk
          path: /zest_desktop/build/outputs/apk/release/*.apk

      # ç¼“å­˜ä¾èµ–
      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
          key: ${{ runner.os }}-pub-cache-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-cache-

      # è·å– Flutter ä¾èµ–
      - name: Get Flutter dependencies
        run: flutter pub get

      # æ„å»º Release APK
      - name: Build Release APK
        run: flutter build apk --release

      # ä¸Šä¼ ç”Ÿæˆçš„ APK
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: flutter-release-apk
          path: build/app/outputs/flutter-apk/app-release.apk

#      - name: è®¾ç½®flutterç‰ˆæœ¬
#        uses: subosito/flutter-action@v2
#        with:
#          channel: stable
#          flutter-version: 3.22.0
#      - run: flutter --version
#      - run: flutter pub get
#      - run: dart run build_runner build --delete-conflicting-outputs
#
#      - name: æ‰“å°ç‰ˆæœ¬å·
#        run: |
#            echo "version: ${{ env.version }}"
#
#      # #å®‰å“ç›®å½•é‡Œé¢å·²ç»é…ç½® key.propertiesæ–‡ä»¶ä»¥åŠ jksæ–‡ä»¶ç­‰é…ç½®æ—¶ï¼Œä½¿ç”¨ä¸‹é¢ğŸ‘‡ğŸ»
#      # - name: ç­¾åå¹¶æ‰“åŒ…apk
#      #   uses: r0adkll/sign-android-release@v1
#      #   # ç”¨äºè®¿é—®åŠ¨ä½œè¾“å‡ºçš„ ID
#      #   id: sign_app
#      #   with:
#      #     releaseDirectory: app/build/outputs/apk/release
#      #     signingKeyBase64: ${{ secrets.SIGNING_KEY }}
#      #     alias: ${{ secrets.KEY_ALIAS  }}
#      #     keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
#      #     keyPassword: ${{ secrets.KEY_PASSWORD }}
#      #   env:
#      #      BUILD_TOOLS_VERSION: "34.0.0"
#
#      # #å®‰å“ç›®å½•é‡Œé¢æ²¡æœ‰é…ç½® key.propertiesæ–‡ä»¶ä»¥åŠ jksæ–‡ä»¶ç­‰é…ç½®æ—¶ï¼Œä½¿ç”¨ä¸‹é¢ğŸ‘‡ğŸ»
#      # - name: åˆ›å»º key.propertiesæ–‡ä»¶
#      #   run: |
#      #     echo "storePassword=${{secrets.KEY_STORE_PASSWORD}}" > key.properties
#      #     echo "keyPassword=${{secrets.KEY_PASSWORD}}" >> key.properties
#      #     echo "keyAlias=${{secrets.KEY_ALIAS}}" >> key.properties
#      #     echo "storeFile=testhani.jks" >> key.properties
#      #     ls -laq
#      #     cat key.properties
#      #   working-directory: android
#
#      # - name: ç¼–ç å¹¶åˆ›å»ºjksæ–‡ä»¶
#      #   run: echo ${{ secrets.SIGNING_KEY}} | base64 --decode > android/testhani.jks
#
#      # - run: flutter pub get
#      # - run: dart run build_runner build --delete-conflicting-outputs
#
#      - name: Build APK
#        # # æ„å»ºä¸åŒæ¶æ„çš„ apk, armeabi-v7a arm64-v8a x86_64
#        run: flutter build apk --split-per-abi
#        # run: flutter build apk --obfuscate --split-debug-info=./symbols
#        # run: flutter build apk --release
#
#      # - name: Ls output directory
#      #   run: ls -laq build/app/outputs/flutter-apk/
#
#      - name: Push APK to Releases
#        uses: ncipollo/release-action@v1
#        with:
#            artifacts: "build/app/outputs/apk/debug/*.apk"
#            token: ${{ secrets.AUTH_TOKEN }}
#
#      # - name: Create Release
#      #   id: create_release
#      #   uses: actions/create-release@v1
#      #   env:
#      #     GITHUB_TOKEN: ${{ secrets.AUTH_TOKEN }}
#      #   with:
#      #     tag_name: ${{ github.ref_name }}
#      #     release_name: ${{ github.ref_name }}
#      #     draft: false
#      #     prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') }}
#      #     body: ${{ github.event.head_commit.message }}
#
#      # - name: Upload apk Release Asset
#      #   uses: actions/upload-release-asset@v1
#      #   env:
#      #     GITHUB_TOKEN: ${{ secrets.AUTH_TOKEN }}
#      #   with:
#      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
#      #     asset_path: ./build/app/outputs/flutter-apk/app-release.apk
#      #     asset_name: app-release.apk
#      #     asset_content_type: application/vnd.android.package-archive
#
#      # - name: apkä¸Šä¼ åˆ°è’²å…¬è‹±
#      #   id: pgyer
#      #   uses: xtayga/upload-pgyer-action@master
#      #   with:
#      #     url: https://www.pgyer.com/apiv2/app/upload
#      #     forms: '{"_api_key":"${{ secrets.PGY_KEY }}","buildName":"RSSAndroid"}'
#      #     fileForms: '{"file":"build/app/outputs/apk/release/app-release.apk"}'
