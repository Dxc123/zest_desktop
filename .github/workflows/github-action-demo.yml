name: Flutter è‡ªåŠ¨åŒ–æ‰“åŒ…
#è§¦å‘äº‹ä»¶
on:
  push:
    branches:
      - master
#   #è¡¨ç¤ºåœ¨æœ‰tagè¢«pushï¼Œä¸”tagæ˜¯ä»¥vå¼€å¤´æ—¶ï¼Œè¿è¡Œè¿™ä¸ªactionã€‚
#   # git tag v1.0.0
#   # git push --tags
#    tags:
#      - "v*"

# å¹¶å‘ç­–ç•¥
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  # å¦‚æœæœ‰æ–°çš„è¿è¡Œå®ä¾‹ï¼Œå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„å®ä¾‹
  cancel-in-progress: true


jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ‹‰å–æ£€æµ‹ä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Javaç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: é…ç½®å®‰å“ Gradle
        uses: gradle/actions/setup-gradle@v4

      # - name: Build with Gradle
      #   run: ./gradlew build

      - name: è®¾ç½®flutterç‰ˆæœ¬
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.22.0
      - run: flutter --version
      - run: flutter pub get
      - run: dart run build_runner build --delete-conflicting-outputs  

      - name: æ‰“å°ç‰ˆæœ¬å·
        run: |
            echo "version: ${{ env.version }}"
            
      # #å®‰å“ç›®å½•é‡Œé¢å·²ç»é…ç½® key.propertiesæ–‡ä»¶ä»¥åŠ jksæ–‡ä»¶ç­‰é…ç½®æ—¶ï¼Œä½¿ç”¨ä¸‹é¢ğŸ‘‡ğŸ»
      # - name: ç­¾åå¹¶æ‰“åŒ…apk
      #   uses: r0adkll/sign-android-release@v1
      #   # ç”¨äºè®¿é—®åŠ¨ä½œè¾“å‡ºçš„ ID
      #   id: sign_app
      #   with:
      #     releaseDirectory: app/build/outputs/apk/release
      #     signingKeyBase64: ${{ secrets.SIGNING_KEY }}
      #     alias: ${{ secrets.KEY_ALIAS  }}
      #     keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
      #     keyPassword: ${{ secrets.KEY_PASSWORD }}
      #   env:
      #      BUILD_TOOLS_VERSION: "34.0.0"

      # #å®‰å“ç›®å½•é‡Œé¢æ²¡æœ‰é…ç½® key.propertiesæ–‡ä»¶ä»¥åŠ jksæ–‡ä»¶ç­‰é…ç½®æ—¶ï¼Œä½¿ç”¨ä¸‹é¢ğŸ‘‡ğŸ»
      # - name: åˆ›å»º key.propertiesæ–‡ä»¶
      #   run: |
      #     echo "storePassword=${{secrets.KEY_STORE_PASSWORD}}" > key.properties
      #     echo "keyPassword=${{secrets.KEY_PASSWORD}}" >> key.properties
      #     echo "keyAlias=${{secrets.KEY_ALIAS}}" >> key.properties
      #     echo "storeFile=testhani.jks" >> key.properties
      #     ls -laq
      #     cat key.properties
      #   working-directory: android

      # - name: ç¼–ç å¹¶åˆ›å»ºjksæ–‡ä»¶
      #   run: echo ${{ secrets.SIGNING_KEY}} | base64 --decode > android/testhani.jks

      # - run: flutter pub get
      # - run: dart run build_runner build --delete-conflicting-outputs  

      - name: Build APK
        # # æ„å»ºä¸åŒæ¶æ„çš„ apk, armeabi-v7a arm64-v8a x86_64
        run: flutter build apk --split-per-abi
        # run: flutter build apk --obfuscate --split-debug-info=./symbols 
        # run: flutter build apk --release

      # - name: Ls output directory
      #   run: ls -laq build/app/outputs/flutter-apk/

      - name: Push APK to Releases
        uses: ncipollo/release-action@v1
        with:
            artifacts: "build/app/outputs/apk/debug/*.apk"
            token: ${{ secrets.AUTH_TOKEN }}

      # - name: Create Release
      #   id: create_release
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.AUTH_TOKEN }}
      #   with:
      #     tag_name: ${{ github.ref_name }}
      #     release_name: ${{ github.ref_name }}
      #     draft: false
      #     prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') }}
      #     body: ${{ github.event.head_commit.message }}

      # - name: Upload apk Release Asset
      #   uses: actions/upload-release-asset@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.AUTH_TOKEN }}
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: ./build/app/outputs/flutter-apk/app-release.apk
      #     asset_name: app-release.apk
      #     asset_content_type: application/vnd.android.package-archive

      # - name: apkä¸Šä¼ åˆ°è’²å…¬è‹±
      #   id: pgyer
      #   uses: xtayga/upload-pgyer-action@master
      #   with:
      #     url: https://www.pgyer.com/apiv2/app/upload
      #     forms: '{"_api_key":"${{ secrets.PGY_KEY }}","buildName":"RSSAndroid"}'
      #     fileForms: '{"file":"build/app/outputs/apk/release/app-release.apk"}'
